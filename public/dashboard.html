<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Smart Hydroponic System</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- Firebase v9 -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa;
        }
        .card {
            border-radius: 15px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            transition: transform 0.3s;
        }
        .card:hover {
            transform: translateY(-5px);
        }
        .card-header {
            border-radius: 15px 15px 0 0 !important;
            font-weight: bold;
        }
        .sensor-value {
            font-size: 2rem;
            font-weight: bold;
        }
        .sensor-unit {
            font-size: 1rem;
            color: #6c757d;
        }
        .status-indicator {
            width: 15px;
            height: 15px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 5px;
        }
        .status-connected {
            background-color: #28a745;
        }
        .status-disconnected {
            background-color: #dc3545;
        }
        .navbar-brand {
            font-weight: bold;
            font-size: 1.5rem;
        }
        #connection-status {
            font-size: 0.9rem;
        }
        .control-card {
            background-color: #f1f8ff;
        }
        .chart-container {
            position: relative;
            height: 250px;
            width: 100%;
        }
        .control-btn {
            width: 100%;
            margin-bottom: 10px;
            padding: 10px;
            font-weight: bold;
        }
        .admin-badge {
            background-color: #dc3545;
            color: white;
            font-size: 0.8rem;
            padding: 3px 8px;
            border-radius: 10px;
            margin-left: 10px;
        }
        .motor-control-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 10px;
        }
        .motor-status {
            font-weight: bold;
            margin-bottom: 5px;
            padding: 2px 8px;
            border-radius: 4px;
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
        }
        .motor-btn {
            width: 50%;
            transition: all 0.3s;
        }
        .motor-btn.active {
            opacity: 1;
            box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25);
        }
        .motor-btn:not(.active) {
            opacity: 0.6;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary mb-4">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="fas fa-leaf me-2"></i>Smart Hydroponic System
                <span class="admin-badge">ADMIN</span>
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="index.html">Public View</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="sheets-dashboard.html">Google Sheets Dashboard</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="dashboard.html">Admin Dashboard</a>
                    </li>
                </ul>
                <div class="d-flex align-items-center">
                    <div class="me-3" id="connection-status">
                        <span class="status-indicator status-disconnected"></span>
                        <span>Disconnected</span>
                    </div>
                    <button id="logout-btn" class="btn btn-sm btn-outline-light">
                        <i class="fas fa-sign-out-alt me-1"></i>Logout
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="alert alert-info" role="alert">
                    <i class="fas fa-info-circle me-2"></i>
                    <span id="last-updated">Loading system data...</span>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Environment Sensors -->
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <i class="fas fa-temperature-high me-2"></i>Environment
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-6 text-center mb-3">
                                <div class="sensor-label">Temperature</div>
                                <div class="sensor-value" id="temperature">--</div>
                                <div class="sensor-unit">°C</div>
                            </div>
                            <div class="col-6 text-center mb-3">
                                <div class="sensor-label">Humidity</div>
                                <div class="sensor-value" id="humidity">--</div>
                                <div class="sensor-unit">%</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Water Parameters -->
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header bg-info text-white">
                        <i class="fas fa-tint me-2"></i>Water Parameters
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-4 text-center mb-3">
                                <div class="sensor-label">TDS</div>
                                <div class="sensor-value" id="tds">--</div>
                                <div class="sensor-unit">ppm</div>
                            </div>
                            <div class="col-4 text-center mb-3">
                                <div class="sensor-label">pH</div>
                                <div class="sensor-value" id="ph">--</div>
                                <div class="sensor-unit"></div>
                            </div>
                            <div class="col-4 text-center mb-3">
                                <div class="sensor-label">EC</div>
                                <div class="sensor-value" id="ec">--</div>
                                <div class="sensor-unit">μS/cm</div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-12">
                                <div class="progress" style="height: 25px;">
                                    <div id="water-level-bar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
                                </div>
                                <div class="text-center mt-1">Water Level</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Water Parameters -->
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header bg-info text-white">
                        <i class="fas fa-tint me-2"></i>Water Parameters
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-6 text-center mb-3">
                                <div class="sensor-label">Water Humidity</div>
                                <div class="sensor-value" id="water-humidity">--</div>
                                <div class="sensor-unit">%</div>
                            </div>
                            <div class="col-6 text-center mb-3">
                                <div class="sensor-label">Water Temperature</div>
                                <div class="sensor-value" id="water-temperature">--</div>
                                <div class="sensor-unit">°C</div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-6 text-center mb-3">
                                <div class="sensor-label">Water Conductivity</div>
                                <div class="sensor-value" id="water-conductivity">--</div>
                                <div class="sensor-unit">μS/cm</div>
                            </div>
                            <div class="col-6 text-center mb-3">
                                <div class="sensor-label">Water pH</div>
                                <div class="sensor-value" id="water-ph">--</div>
                                <div class="sensor-unit">pH</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-4">
            <!-- Nutrients -->
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header bg-danger text-white">
                        <i class="fas fa-flask me-2"></i>Nutrients
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-4 text-center mb-3">
                                <div class="sensor-label">Nitrogen (N)</div>
                                <div class="sensor-value" id="nitrogen">--</div>
                                <div class="sensor-unit">mg/kg</div>
                            </div>
                            <div class="col-4 text-center mb-3">
                                <div class="sensor-label">Phosphorus (P)</div>
                                <div class="sensor-value" id="phosphorus">--</div>
                                <div class="sensor-unit">mg/kg</div>
                            </div>
                            <div class="col-4 text-center mb-3">
                                <div class="sensor-label">Potassium (K)</div>
                                <div class="sensor-value" id="potassium">--</div>
                                <div class="sensor-unit">mg/kg</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- System Control -->
            <div class="col-md-8">
                <div class="card control-card">
                    <div class="card-header bg-primary text-white">
                        <i class="fas fa-sliders-h me-2"></i>System Control (Admin Only)
                    </div>
                    <div class="card-body">
                        <div class="form-check form-switch mb-3">
                            <input class="form-check-input" type="checkbox" id="auto-mode-switch" checked>
                            <label class="form-check-label" for="auto-mode-switch">Auto Mode</label>
                        </div>
                        
                        <div id="manual-controls" style="display: none;">
                            <h5 class="mb-3">Manual Motor Controls</h5>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Water Pump</label>
                                        <div class="motor-control-container">
                                            <div class="motor-status" id="water-pump-status">OFF</div>
                                            <div class="btn-group w-100" role="group">
                                                <button type="button" class="btn btn-success motor-btn" id="water-pump-on" onclick="toggleMotor('water_level', 'on', this)">ON</button>
                                                <button type="button" class="btn btn-danger motor-btn active" id="water-pump-off" onclick="toggleMotor('water_level', 'off', this)">OFF</button>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Nutrient Pump</label>
                                        <div class="motor-control-container">
                                            <div class="motor-status" id="nutrient-pump-status">OFF</div>
                                            <div class="btn-group w-100" role="group">
                                                <button type="button" class="btn btn-success motor-btn" id="nutrient-pump-on" onclick="toggleMotor('nutrient_add', 'on', this)">ON</button>
                                                <button type="button" class="btn btn-danger motor-btn active" id="nutrient-pump-off" onclick="toggleMotor('nutrient_add', 'off', this)">OFF</button>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Nutrient Mixing Motor</label>
                                        <div class="motor-control-container">
                                            <div class="motor-status" id="mixing-motor-status">OFF</div>
                                            <div class="btn-group w-100" role="group">
                                                <button type="button" class="btn btn-success motor-btn" id="mixing-motor-on" onclick="toggleMotor('nutrient_mix', 'on', this)">ON</button>
                                                <button type="button" class="btn btn-danger motor-btn active" id="mixing-motor-off" onclick="toggleMotor('nutrient_mix', 'off', this)">OFF</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">pH Up Pump</label>
                                        <div class="motor-control-container">
                                            <div class="motor-status" id="ph-up-status">OFF</div>
                                            <div class="btn-group w-100" role="group">
                                                <button type="button" class="btn btn-success motor-btn" id="ph-up-on" onclick="toggleMotor('ph_up', 'on', this)">ON</button>
                                                <button type="button" class="btn btn-danger motor-btn active" id="ph-up-off" onclick="toggleMotor('ph_up', 'off', this)">OFF</button>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">pH Down Pump</label>
                                        <div class="motor-control-container">
                                            <div class="motor-status" id="ph-down-status">OFF</div>
                                            <div class="btn-group w-100" role="group">
                                                <button type="button" class="btn btn-success motor-btn" id="ph-down-on" onclick="toggleMotor('ph_down', 'on', this)">ON</button>
                                                <button type="button" class="btn btn-danger motor-btn active" id="ph-down-off" onclick="toggleMotor('ph_down', 'off', this)">OFF</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div id="auto-controls">
                            <h5 class="mb-3">Target Values (Auto Mode)</h5>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="target-tds" class="form-label">Target TDS (ppm)</label>
                                        <input type="number" class="form-control" id="target-tds" min="0" max="2000" value="800">
                                    </div>
                                    <div class="mb-3">
                                        <label for="target-ec" class="form-label">Target EC (μS/cm)</label>
                                        <input type="number" class="form-control" id="target-ec" min="0" max="4000" value="1500">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="target-ph" class="form-label">Target pH</label>
                                        <input type="number" class="form-control" id="target-ph" min="0" max="14" step="0.1" value="6.5">
                                    </div>
                                    <div class="mb-3">
                                        <label for="target-water-level" class="form-label">Target Water Level (%)</label>
                                        <input type="number" class="form-control" id="target-water-level" min="0" max="100" value="80">
                                    </div>
                                </div>
                            </div>
                            <button type="button" class="btn btn-success w-100" id="apply-targets">
                                <i class="fas fa-check-circle me-2"></i>Apply Target Values
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-4">
            <!-- Historical Data -->
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header bg-secondary text-white">
                        <i class="fas fa-chart-line me-2"></i>Historical Data
                        <div class="d-flex justify-content-end align-items-center">
                            <div class="me-2">
                                <select class="form-select form-select-sm" id="time-range">
                                    <option value="12">Last 12 hours</option>
                                    <option value="24">Last 24 hours</option>
                                    <option value="48">Last 2 days</option>
                                    <option value="168">Last week</option>
                                    <option value="720">Last month</option>
                                </select>
                            </div>
                            <div>
                                <select class="form-select form-select-sm" id="chart-parameter">
                                    <option value="temperature">Temperature</option>
                                    <option value="humidity">Humidity</option>
                                    <option value="tds">TDS</option>
                                    <option value="ph">pH</option>
                                    <option value="ec">EC</option>
                                    <option value="waterLevel">Water Level</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="history-chart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Check authentication status
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize Firebase
            const firebaseConfig = {
                apiKey: "AIzaSyB945vphu9m3e1NzVEfcbhTkwQsKPz-rOw",
                authDomain: "your-project-id.firebaseapp.com",
                databaseURL: "https://your-project-id-default-rtdb.your-region.firebasedatabase.app",
                projectId: "your-project-id",
                storageBucket: "your-project-id.appspot.com",
                messagingSenderId: "1234567890",
                appId: "1:1234567890:web:abcdef123456",
                measurementId: "G-XXXXXXXXXX"
            };
            
            // Initialize Firebase
            firebase.initializeApp(firebaseConfig);

            const googleScriptUrl = 'YOUR_GOOGLE_APPS_SCRIPT_WEB_APP_URL';

            firebase.auth().onAuthStateChanged((user) => {
                if (user) {
                    // User is signed in, initialize the app
                    initApp();
                } else {
                    // User is not signed in, redirect to login
                    window.location.href = 'admin.html';
                }
            });
            
            // Logout button
            document.getElementById('logout-btn').addEventListener('click', function() {
                firebase.auth().signOut().then(() => {
                    // Sign-out successful, redirect to login
                    localStorage.removeItem('hydroponicAdminAuth');
                    window.location.href = 'admin.html';
                }).catch((error) => {
                    // An error happened
                    console.error('Logout error:', error);
                });
            });
        });
        
        // Initialize the app after authentication
        function initApp() {
            // Get a reference to the database service
            const database = firebase.database();
            
            // Set up real-time listeners
            const latestReadingsRef = database.ref('latest_readings');
            latestReadingsRef.on('value', (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    updateUI(data);
                    updateConnectionStatus(true, 'Firebase');
                } else {
                    console.log('No data available in Firebase');
                    document.getElementById('last-updated').textContent = 'No data available in Firebase database';
                }
            }, (error) => {
                console.error('Database read error:', error);
                document.getElementById('last-updated').textContent = 'Error reading from Firebase: ' + error.message;
                updateConnectionStatus(false, 'Firebase');
            });
            
            // Initialize chart
            initChart();
            
            // Initialize motor states
            initMotorStates(database);
            
            // Set up auto/manual mode switch
            document.getElementById('auto-mode-switch').addEventListener('change', function() {
                const isAuto = this.checked;
                document.getElementById('manual-controls').style.display = isAuto ? 'none' : 'block';
                document.getElementById('auto-controls').style.display = isAuto ? 'block' : 'none';
                
                // Update mode in Firebase
                database.ref('control/mode').set(isAuto ? 'auto' : 'manual');
            });
            
            // Check current mode from Firebase
            database.ref('control/mode').once('value', (snapshot) => {
                const mode = snapshot.val() || 'auto';
                const autoSwitch = document.getElementById('auto-mode-switch');
                autoSwitch.checked = mode === 'auto';
                document.getElementById('manual-controls').style.display = mode === 'auto' ? 'none' : 'block';
                document.getElementById('auto-controls').style.display = mode === 'auto' ? 'block' : 'none';
            });
            
            // Note: Chart parameter selector event listener is now handled in the initChartWithData function
            // This ensures proper debouncing and prevents duplicate event listeners
            
            // Set up apply target values button
            document.getElementById('apply-targets').addEventListener('click', function() {
                const targetTDS = document.getElementById('target-tds').value;
                const targetEC = document.getElementById('target-ec').value;
                const targetPH = document.getElementById('target-ph').value;
                const targetWaterLevel = document.getElementById('target-water-level').value;
                
                // Update target values in Firebase
                database.ref('control/targets').set({
                    tds: parseInt(targetTDS),
                    ec: parseInt(targetEC),
                    ph: parseFloat(targetPH),
                    waterLevel: parseInt(targetWaterLevel)
                }).then(() => {
                    alert('Target values updated successfully!');
                }).catch((error) => {
                    alert('Error updating target values: ' + error.message);
                });
            });
            
            // Check for existing target values
            database.ref('control/targets').once('value', (snapshot) => {
                const targets = snapshot.val();
                if (targets) {
                    document.getElementById('target-tds').value = targets.tds || 800;
                    document.getElementById('target-ec').value = targets.ec || 1500;
                    document.getElementById('target-ph').value = targets.ph || 6.5;
                    document.getElementById('target-water-level').value = targets.waterLevel || 80;
                }
            });
            
            // Check for existing mode
            database.ref('control/mode').once('value', (snapshot) => {
                const mode = snapshot.val();
                if (mode) {
                    const isAuto = mode === 'auto';
                    document.getElementById('auto-mode-switch').checked = isAuto;
                    document.getElementById('manual-controls').style.display = isAuto ? 'none' : 'block';
                    document.getElementById('auto-controls').style.display = isAuto ? 'block' : 'none';
                }
            });
        }
        
        function updateUI(data) {
            // Update sensor values
            document.getElementById('temperature').textContent = data.temperature ? data.temperature.toFixed(1) : '--';
            document.getElementById('humidity').textContent = data.humidity ? data.humidity.toFixed(1) : '--';
            document.getElementById('tds').textContent = data.tds ? data.tds.toFixed(0) : '--';
            document.getElementById('ph').textContent = data.ph ? data.ph.toFixed(2) : '--';
            document.getElementById('ec').textContent = data.ec ? data.ec.toFixed(0) : '--';
            
            // Update water level
            const waterLevelBar = document.getElementById('water-level-bar');
            if (data.waterLevel !== undefined) {
                const level = data.waterLevel;
                waterLevelBar.style.width = level + '%';
                waterLevelBar.textContent = level + '%';
                waterLevelBar.setAttribute('aria-valuenow', level);
            }
            
            // Update water parameters
            document.getElementById('water-humidity').textContent = data.waterHumidity ? data.waterHumidity.toFixed(1) : '--';
            document.getElementById('water-temperature').textContent = data.waterTemperature ? data.waterTemperature.toFixed(1) : '--';
            
            // Display conductivity in both μS/cm and mS/cm
            if (data.waterConductivity) {
                const microS = data.waterConductivity;
                const milliS = (microS / 1000).toFixed(2);
                document.getElementById('water-conductivity').textContent = `${microS} (${milliS} mS/cm)`;
            } else {
                document.getElementById('water-conductivity').textContent = '--';
            }
            
            document.getElementById('water-ph').textContent = data.waterPH ? data.waterPH.toFixed(2) : '--';
            
            // Update nutrients
            document.getElementById('nitrogen').textContent = data.nitrogen ? data.nitrogen.toFixed(0) : '--';
            document.getElementById('phosphorus').textContent = data.phosphorus ? data.phosphorus.toFixed(0) : '--';
            document.getElementById('potassium').textContent = data.potassium ? data.potassium.toFixed(0) : '--';
            
            // Update last updated time
            // Since ESP32 is using millis() which isn't a proper timestamp,
            // we'll use the current time instead
            const date = new Date();
            document.getElementById('last-updated').textContent = `Last updated: ${date.toLocaleString()}`;
        }
        
        function updateConnectionStatus(isConnected, source) {
            const statusIndicator = document.querySelector('.status-indicator');
            const statusText = document.querySelector('#connection-status span:nth-child(2)');
            
            if (isConnected) {
                statusIndicator.classList.remove('status-disconnected');
                statusIndicator.classList.add('status-connected');
                statusText.textContent = `Connected to ${source}`;
            } else {
                statusIndicator.classList.remove('status-connected');
                statusIndicator.classList.add('status-disconnected');
                statusText.textContent = 'Disconnected';
            }
        }
        
        // Chart variables
        let historyChart = null;
        
        // Store the chart data for quick parameter switching
        let chartDataCache = null;

        // !!! IMPORTANT: Replace with your deployed Google Apps Script URL !!!
        const googleScriptUrl = 'YOUR_GOOGLE_APPS_SCRIPT_URL_HERE'; // e.g. 'https://script.google.com/macros/s/YOUR_DEPLOYMENT_ID/exec';

        // Global variable to store historical data from Google Sheets (array) or Firebase (object for fallback)
        let globalHistoricalData = null; // This will be the single source of truth
        
        function initChart() {
            // Initial data fetch
            fetchHistoricalData();
            
            // Add event listener for time range change
            document.getElementById('time-range').addEventListener('change', function() {
                if (globalHistoricalData) {
                    generateChartData(parseInt(this.value));
                } else {
                    fetchHistoricalData();
                }
            });
        }
        
        // Function to fetch and generate historical data
        function fetchHistoricalData() {
            console.log('Fetching data for chart...');
            document.getElementById('history-chart').style.opacity = '0.5';
            const timeRangeHours = parseInt(document.getElementById('time-range').value) || 12;
            const database = firebase.database(); // Firebase instance for fallback
            console.log(`Attempting to fetch data from Google Sheets for the last ${timeRangeHours} hours (approx)`);

            // Try to fetch data from Google Sheets first
            fetch(`${googleScriptUrl}?action=getChartData`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(sheetData => {
                    if (sheetData && Array.isArray(sheetData) && sheetData.length > 0) {
                        console.log('Data received from Google Sheets:', sheetData.length, 'records');
                        globalHistoricalData = sheetData; // sheetData is an array of objects
                        generateChartData(timeRangeHours); 
                    } else if (sheetData && sheetData.error) {
                        console.error('Error from Google Sheets script:', sheetData.error);
                        console.log('Falling back to Firebase for chart data.');
                        fallbackToFirebaseData(database, timeRangeHours);
                    } else {
                        console.log('No data returned from Google Sheets or data is not an array. Falling back to Firebase.');
                        fallbackToFirebaseData(database, timeRangeHours);
                    }
                })
                .catch(error => {
                    console.error('Error fetching data from Google Sheets:', error);
                    console.log('Falling back to Firebase for chart data.');
                    fallbackToFirebaseData(database, timeRangeHours);
                });
        }

        function fallbackToFirebaseData(db, timeRangeHours) {
            console.log('Attempting to fetch historical data from Firebase sensor_data...');
            db.ref('sensor_data').orderByChild('timestamp').limitToLast(1000).once('value')
                .then(snapshot => {
                    const historicalData = snapshot.val();
                    if (historicalData && Object.keys(historicalData).length > 0) {
                        console.log('Firebase historical data (sensor_data) received:', Object.keys(historicalData).length, 'records');
                        globalHistoricalData = historicalData; // Store as object for Firebase path
                        generateChartData(timeRangeHours); // Call generateChartData to process it
                    } else {
                        console.log('No historical data in Firebase sensor_data, using latest_readings for mock data.');
                        db.ref('latest_readings').once('value')
                            .then(latestSnapshot => {
                                const latestData = latestSnapshot.val();
                                if (latestData) {
                                    generateMockData(latestData, timeRangeHours);
                                } else {
                                    generateDemoData(timeRangeHours);
                                }
                            })
                            .catch(error => {
                                console.error('Error fetching latest_readings from Firebase:', error);
                                generateDemoData(timeRangeHours);
                            });
                    }
                })
                .catch(error => {
                    console.error('Error fetching historical data from Firebase sensor_data:', error);
                    db.ref('latest_readings').once('value') // Final fallback to latest_readings for mock
                        .then(latestSnapshot => {
                            const latestData = latestSnapshot.val();
                            if (latestData) {
                                generateMockData(latestData, timeRangeHours);
                            } else {
                                generateDemoData(timeRangeHours);
                            }
                        })
                        .catch(latestError => {
                            console.error('Error fetching latest_readings from Firebase as final fallback:', latestError);
                            generateDemoData(timeRangeHours);
                        });
                });
        }
        
        // Generate chart data based on time range from globalHistoricalData
        function generateChartData(timeRangeHours) {
            const parameter = document.getElementById('chart-parameter').value || 'temperature';
            const now = new Date();
            const cutoffTime = now.getTime() - (timeRangeHours * 60 * 60 * 1000);
            const database = firebase.database(); // For fallback to mock/demo

            if (!globalHistoricalData) {
                console.log('No globalHistoricalData available. Attempting to fetch latest for mock/demo.');
                fallbackToMockOrDemoFirebase(database, timeRangeHours);
                document.getElementById('history-chart').style.opacity = '1';
                return;
            }

            if (Array.isArray(globalHistoricalData)) { // Data from Google Sheets
                const filteredSheetData = globalHistoricalData.filter(entry => {
                    const entryTimestamp = Number(entry.timestamp); // Ensure numeric timestamp
                    return !isNaN(entryTimestamp) && entryTimestamp > cutoffTime;
                });

                if (filteredSheetData.length > 0) {
                    console.log(`Displaying ${filteredSheetData.length} data points from Google Sheets for the last ${timeRangeHours} hours`);
                    initChartWithData(filteredSheetData);
                } else {
                    console.log('No data from Google Sheets in the selected time range. Falling back to mock/demo.');
                    fallbackToMockOrDemoFirebase(database, timeRangeHours);
                }
            } else if (typeof globalHistoricalData === 'object' && globalHistoricalData !== null) { // Data from Firebase sensor_data
                const filteredFirebaseData = {};
                Object.entries(globalHistoricalData).forEach(([key, entry]) => {
                    // Ensure entry and entry.timestamp exist and timestamp is numeric
                    if (entry && entry.timestamp && Number(entry.timestamp) > cutoffTime) {
                        filteredFirebaseData[key] = entry;
                    }
                });
                if (Object.keys(filteredFirebaseData).length > 0) {
                    console.log(`Displaying ${Object.keys(filteredFirebaseData).length} data points from Firebase sensor_data for the last ${timeRangeHours} hours`);
                    initChartWithData(filteredFirebaseData);
                } else {
                    console.log('No data from Firebase sensor_data in selected time range. Falling back to mock/demo.');
                    fallbackToMockOrDemoFirebase(database, timeRangeHours);
                }
            } else {
                 console.log('globalHistoricalData is not in an expected format (array or object). Falling back to mock/demo.');
                 fallbackToMockOrDemoFirebase(database, timeRangeHours);
            }
            
            document.getElementById('history-chart').style.opacity = '1';
        }

        function fallbackToMockOrDemoFirebase(db, timeRangeHours) {
            console.log('Executing fallbackToMockOrDemoFirebase');
            db.ref('latest_readings').once('value')
                .then(snapshot => {
                    const latestData = snapshot.val();
                    if (latestData) {
                        console.log('Generating mock data from latest_readings.');
                        generateMockData(latestData, timeRangeHours);
                    } else {
                        console.log('No latest_readings found, generating demo data.');
                        generateDemoData(timeRangeHours);
                    }
                })
                .catch((error) => {
                    console.error('Error in fallbackToMockOrDemoFirebase fetching latest_readings:', error);
                    generateDemoData(timeRangeHours);
                });
        }
        
        // Generate mock data based on latest readings
        function generateMockData(latestData, timeRangeHours) {
            console.log('Generating mock data based on latest readings');
            const mockData = {};
            const now = new Date();
            
            // Calculate number of data points based on time range
            // For longer time ranges, use fewer points to avoid overwhelming the chart
            let numPoints;
            let intervalMinutes;
            
            if (timeRangeHours <= 24) {
                // For 24 hours or less: one point every 15 minutes
                intervalMinutes = 15;
                numPoints = Math.ceil(timeRangeHours * 60 / intervalMinutes);
            } else if (timeRangeHours <= 48) {
                // For 2 days: one point every 30 minutes
                intervalMinutes = 30;
                numPoints = Math.ceil(timeRangeHours * 60 / intervalMinutes);
            } else if (timeRangeHours <= 168) {
                // For 1 week: one point every hour
                intervalMinutes = 60;
                numPoints = Math.ceil(timeRangeHours * 60 / intervalMinutes);
            } else {
                // For 1 month: one point every 3 hours
                intervalMinutes = 180;
                numPoints = Math.ceil(timeRangeHours * 60 / intervalMinutes);
            }
            
            console.log(`Generating ${numPoints} data points with ${intervalMinutes} minute intervals`);
            
            // Generate data points with realistic variations
            for (let i = 0; i < numPoints; i++) {
                const timeKey = now.getTime() - (i * intervalMinutes * 60 * 1000);
                
                // Create variations that make sense over time
                // Use sine waves to create more realistic patterns
                const hourOfDay = new Date(timeKey).getHours();
                const dayFactor = Math.sin((hourOfDay / 24) * Math.PI * 2);
                
                // Temperature varies by time of day (higher during day, lower at night)
                const tempVariation = dayFactor * 2 + (Math.random() * 0.6) - 0.3;
                
                // Humidity varies inversely with temperature
                const humidityVariation = -dayFactor * 5 + (Math.random() * 2) - 1;
                
                // Other parameters have smaller random variations
                const tdsVariation = (Math.random() * 20) - 10 + (i % 3) * 5;
                const phVariation = (Math.random() * 0.2) - 0.1 + (i % 4) * 0.05;
                const ecVariation = (Math.random() * 40) - 20 + (i % 3) * 10;
                const waterLevelVariation = (Math.random() * 5) - 2.5;
                
                mockData['point_' + i] = {
                    temperature: latestData.temperature + tempVariation,
                    humidity: latestData.humidity + humidityVariation,
                    tds: latestData.tds + tdsVariation,
                    ph: latestData.ph + phVariation,
                    ec: latestData.ec + ecVariation,
                    waterLevel: latestData.waterLevel + waterLevelVariation,
                    timestamp: timeKey
                };
            }
            
            console.log('Generated mock data for chart');
            initChartWithData(mockData);
            
            // Remove loading indicator
            document.getElementById('history-chart').style.opacity = '1';
        }
        
        // Generate demo data if no real data is available
        function generateDemoData(timeRangeHours) {
            console.log('Generating demo data');
            const demoData = {};
            const now = new Date();
            
            // Calculate number of data points and interval similar to mock data
            let numPoints;
            let intervalMinutes;
            
            if (timeRangeHours <= 24) {
                intervalMinutes = 15;
                numPoints = Math.ceil(timeRangeHours * 60 / intervalMinutes);
            } else if (timeRangeHours <= 48) {
                intervalMinutes = 30;
                numPoints = Math.ceil(timeRangeHours * 60 / intervalMinutes);
            } else if (timeRangeHours <= 168) {
                intervalMinutes = 60;
                numPoints = Math.ceil(timeRangeHours * 60 / intervalMinutes);
            } else {
                intervalMinutes = 180;
                numPoints = Math.ceil(timeRangeHours * 60 / intervalMinutes);
            }
            
            // Base values for demo data
            const baseTemp = 25;
            const baseHumidity = 60;
            const baseTds = 800;
            const basePh = 6.5;
            const baseEc = 1500;
            const baseWaterLevel = 75;
            
            // Generate data points with realistic variations
            for (let i = 0; i < numPoints; i++) {
                const timeKey = now.getTime() - (i * intervalMinutes * 60 * 1000);
                const hourOfDay = new Date(timeKey).getHours();
                const dayFactor = Math.sin((hourOfDay / 24) * Math.PI * 2);
                
                demoData['point_' + i] = {
                    temperature: baseTemp + dayFactor * 3 + (Math.random() * 1) - 0.5,
                    humidity: baseHumidity - dayFactor * 10 + (Math.random() * 5) - 2.5,
                    tds: baseTds + (Math.random() * 50) - 25 + (i % 5) * 10,
                    ph: basePh + (Math.random() * 0.2) - 0.1 + (i % 6) * 0.05,
                    ec: baseEc + (Math.random() * 100) - 50 + (i % 4) * 25,
                    waterLevel: baseWaterLevel + (Math.random() * 10) - 5,
                    timestamp: timeKey
                };
            }
            
            console.log('Generated demo data for chart');
            initChartWithData(demoData);
            
            // Remove loading indicator
            document.getElementById('history-chart').style.opacity = '1';
        }
        
        function initChartWithData(data) {
            console.log('Initializing chart with data');
            const ctx = document.getElementById('history-chart').getContext('2d');
            
            // Cache the data for quick parameter switching
            chartDataCache = data;
            
            // Destroy existing chart if it exists
            if (historyChart) {
                historyChart.destroy();
            }
            
            historyChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Temperature',
                        data: [],
                        borderColor: 'rgba(255, 99, 132, 1)',
                        backgroundColor: 'rgba(255, 99, 132, 0.2)',
                        borderWidth: 2,
                        tension: 0.3,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: {
                        duration: 500 // Faster animation for better responsiveness
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            grid: {
                                color: 'rgba(200, 200, 200, 0.2)'
                            }
                        },
                        x: {
                            reverse: true,
                            grid: {
                                color: 'rgba(200, 200, 200, 0.2)'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            enabled: true,
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                title: function(tooltipItems) {
                                    if (tooltipItems.length > 0) {
                                        const date = new Date(parseInt(tooltipItems[0].raw.timestamp || tooltipItems[0].raw.x));
                                        return date.toLocaleString();
                                    }
                                    return '';
                                }
                            }
                        }
                    }
                }
            });
            
            // Get selected parameter or default to temperature
            const parameter = document.getElementById('chart-parameter').value || 'temperature';
            console.log('Loading initial chart data with parameter:', parameter);
            
            // Load initial chart data
            updateChartWithData(data, parameter);
            
            // Add event listener for parameter change with debounce
            const parameterSelector = document.getElementById('chart-parameter');
            if (parameterSelector) {
                // Remove existing listeners to prevent duplicates
                const newParamSelector = parameterSelector.cloneNode(true);
                parameterSelector.parentNode.replaceChild(newParamSelector, parameterSelector);
                
                // Add new listener with debounce
                newParamSelector.addEventListener('change', function() {
                    // Show quick loading indicator
                    document.getElementById('history-chart').style.opacity = '0.7';
                    
                    // Use setTimeout to give UI time to update
                    setTimeout(() => {
                        updateChartWithData(chartDataCache, this.value);
                        document.getElementById('history-chart').style.opacity = '1';
                    }, 10);
                }); // <<< Added missing closing brace for addEventListener callback
            }
        }
        
        function updateChartWithData(data, parameter) {
            console.log('Updating chart with parameter:', parameter, 'Data received (type:', typeof data, 'is Array:', Array.isArray(data), '):', data);
            if (!historyChart) {
                console.error('Chart not initialized');
                return;
            }

            const dataPoints = [];
            const labels = [];

            // Set chart colors based on parameter
            let borderColor, backgroundColor;
            switch (parameter) {
                case 'temperature':
                    borderColor = 'rgba(255, 99, 132, 1)';
                    backgroundColor = 'rgba(255, 99, 132, 0.2)';
                    break;
                case 'humidity':
                    borderColor = 'rgba(54, 162, 235, 1)';
                    backgroundColor = 'rgba(54, 162, 235, 0.2)';
                    break;
                case 'tds':
                    borderColor = 'rgba(255, 206, 86, 1)';
                    backgroundColor = 'rgba(255, 206, 86, 0.2)';
                    break;
                case 'ph':
                    borderColor = 'rgba(75, 192, 192, 1)';
                    backgroundColor = 'rgba(75, 192, 192, 0.2)';
                    break;
                case 'ec':
                    borderColor = 'rgba(153, 102, 255, 1)';
                    backgroundColor = 'rgba(153, 102, 255, 0.2)';
                    break;
                case 'waterLevel':
                    borderColor = 'rgba(0, 123, 255, 1)'; 
                    backgroundColor = 'rgba(0, 123, 255, 0.2)';
                    break;
                default:
                    borderColor = 'rgba(255, 99, 132, 1)';
                    backgroundColor = 'rgba(255, 99, 132, 0.2)';
            }

            // Ensure 'entries' is an array of data objects, normalize if necessary
            let entries;
            if (Array.isArray(data)) {
                entries = [...data]; // Use a copy if it's already an array (from Sheets or mock/demo)
            } else if (typeof data === 'object' && data !== null) {
                entries = Object.values(data); // For Firebase-like object of objects
            } else {
                console.error('Invalid data format for chart. Expected array or object of objects. Received:', data);
                entries = [];
            }

            console.log('Processing', entries.length, 'data points after normalization');

            // Sort by timestamp (newest first for display)
            if (entries.length > 0 && entries[0] && typeof entries[0].timestamp !== 'undefined') {
                entries.sort((a, b) => {
                    const tsA = Number(a.timestamp) || 0; // Ensure numeric for comparison
                    const tsB = Number(b.timestamp) || 0; // Ensure numeric for comparison
                    return tsB - tsA; // Descending order (newest first)
                });
            } else if (entries.length > 0) {
                console.warn('First entry is missing timestamp or entries array is malformed, cannot sort by time.');
            }

            // Extract data points and labels
            entries.forEach((entry, index) => {
                // Skip entries without the selected parameter or if entry is null/undefined
                if (!entry || entry[parameter] === undefined) return;
                
                // Convert string values to numbers if needed
                let value = entry[parameter];
                if (typeof value === 'string') {
                    value = parseFloat(value);
                }
                
                // Skip invalid values
                if (isNaN(value)) return;
                
                dataPoints.push(value);
                
                // Create time labels
                let timeLabel;
                if (entry.timestamp) {
                    const date = new Date(Number(entry.timestamp)); // Ensure timestamp is numeric for Date constructor
                    if (date.getFullYear() > 1970) { // Basic check for valid date
                        timeLabel = date.toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'});
                    } else {
                        timeLabel = `Pt ${index + 1}`;
                    }
                } else {
                    timeLabel = `Pt ${index + 1}`;
                }
                labels.push(timeLabel);
            });

            console.log('Chart data prepared:', {
                labels: labels.length,
                dataPoints: dataPoints.length,
                parameter: parameter
            });

            // Update chart with new data
            historyChart.data.labels = labels.reverse(); // Reverse labels for correct chronological order on chart (oldest to newest)
            historyChart.data.datasets[0].label = parameter.charAt(0).toUpperCase() + parameter.slice(1);
            historyChart.data.datasets[0].data = dataPoints.reverse(); // Reverse data for correct chronological order
            historyChart.data.datasets[0].borderColor = borderColor;
            historyChart.data.datasets[0].backgroundColor = backgroundColor;

            // Update y-axis label based on parameter
            let yAxisLabel = '';
            switch (parameter) {
                case 'temperature': yAxisLabel = '°C'; break;
                case 'humidity': yAxisLabel = '%'; break;
                case 'tds': yAxisLabel = 'ppm'; break;
                case 'ph': yAxisLabel = 'pH'; break;
                case 'ec': yAxisLabel = 'μS/cm'; break;
                case 'waterLevel': yAxisLabel = '%'; break;
            }

            historyChart.options.scales.y.title = {
                display: true,
                text: yAxisLabel
            };
            
            historyChart.update();
            console.log('Chart updated successfully');
        }
        
        function toggleMotor(motor, state, buttonElement) {
            // Get the motor's container elements
            let statusId, onBtnId, offBtnId;
            
            switch(motor) {
                case 'water_level':
                    statusId = 'water-pump-status';
                    onBtnId = 'water-pump-on';
                    offBtnId = 'water-pump-off';
                    break;
                case 'nutrient_add':
                    statusId = 'nutrient-pump-status';
                    onBtnId = 'nutrient-pump-on';
                    offBtnId = 'nutrient-pump-off';
                    break;
                case 'nutrient_mix':
                    statusId = 'mixing-motor-status';
                    onBtnId = 'mixing-motor-on';
                    offBtnId = 'mixing-motor-off';
                    break;
                case 'ph_up':
                    statusId = 'ph-up-status';
                    onBtnId = 'ph-up-on';
                    offBtnId = 'ph-up-off';
                    break;
                case 'ph_down':
                    statusId = 'ph-down-status';
                    onBtnId = 'ph-down-on';
                    offBtnId = 'ph-down-off';
                    break;
                default:
                    console.error('Unknown motor:', motor);
                    return;
            }
            
            const statusElement = document.getElementById(statusId);
            const onButton = document.getElementById(onBtnId);
            const offButton = document.getElementById(offBtnId);
            
            // Update motor state in Firebase
            firebase.database().ref(`control/relays/${motor}`).set(state)
                .then(() => {
                    console.log(`Motor ${motor} set to ${state}`);
                    
                    // Update UI
                    if (state === 'on') {
                        statusElement.textContent = 'ON';
                        statusElement.style.color = '#28a745';
                        onButton.classList.add('active');
                        offButton.classList.remove('active');
                    } else {
                        statusElement.textContent = 'OFF';
                        statusElement.style.color = '#dc3545';
                        offButton.classList.add('active');
                        onButton.classList.remove('active');
                    }
                })
                .catch((error) => {
                    console.error(`Error controlling motor ${motor}:`, error);
                    alert(`Error controlling motor: ${error.message}`);
                });
        }
        
        // Function to initialize motor states from Firebase
        function initMotorStates(database) {
            database.ref('control/relays').on('value', (snapshot) => {
                const motorStates = snapshot.val() || {};
                
                // Update UI for each motor based on its state
                if (motorStates.water_level) {
                    toggleMotor('water_level', motorStates.water_level, null);
                }
                if (motorStates.nutrient_add) {
                    toggleMotor('nutrient_add', motorStates.nutrient_add, null);
                }
                if (motorStates.nutrient_mix) {
                    toggleMotor('nutrient_mix', motorStates.nutrient_mix, null);
                }
                if (motorStates.ph_up) {
                    toggleMotor('ph_up', motorStates.ph_up, null);
                }
                if (motorStates.ph_down) {
                    toggleMotor('ph_down', motorStates.ph_down, null);
                }
            });
        }

        // 12-Hour Data Aggregation System
        
        // Function to process 12-hour averages of sensor data
        function process12HourAverages() {
            const database = firebase.database();
            const now = Date.now();
            const twelveHoursAgo = now - (12 * 60 * 60 * 1000);
            
            // Show processing notification
            const processingNotification = document.createElement('div');
            processingNotification.className = 'alert alert-info';
            processingNotification.innerHTML = '<i class="fas fa-sync fa-spin me-2"></i>Processing 12-hour data averages...';
            processingNotification.style.position = 'fixed';
            processingNotification.style.top = '10px';
            processingNotification.style.right = '10px';
            processingNotification.style.zIndex = '9999';
            document.body.appendChild(processingNotification);
            
            console.log('Starting 12-hour data aggregation process...');
            console.log(`Time range: ${new Date(twelveHoursAgo).toLocaleString()} to ${new Date(now).toLocaleString()}`);
            
            // Step 1: Fetch the last 12 hours of data
            database.ref('sensor_data')
                .orderByChild('timestamp')
                .startAt(twelveHoursAgo)
                .endAt(now)
                .once('value', (snapshot) => {
                    if (!snapshot.exists()) {
                        console.log('No data found for the last 12 hours');
                        document.body.removeChild(processingNotification);
                        showNotification('No data found for the last 12 hours', 'warning');
                        return;
                    }
                    
                    // Variables to calculate averages
                    let sumTemp = 0, sumHumidity = 0, sumTds = 0, sumPh = 0, sumEc = 0;
                    let sumWaterLevel = 0, sumWaterTemp = 0;
                    let sumNitrogen = 0, sumPhosphorus = 0, sumPotassium = 0;
                    let count = 0;
                    
                    // Keys to delete after processing
                    const keysToDelete = [];
                    
                    // Process all data points
                    snapshot.forEach(childSnapshot => {
                        const data = childSnapshot.val();
                        keysToDelete.push(childSnapshot.key);
                        count++;
                        
                        // Add all values (check if they exist first)
                        if (data.temperature) sumTemp += parseFloat(data.temperature) || 0;
                        if (data.humidity) sumHumidity += parseFloat(data.humidity) || 0;
                        if (data.tds) sumTds += parseFloat(data.tds) || 0;
                        if (data.ph) sumPh += parseFloat(data.ph) || 0;
                        if (data.ec) sumEc += parseFloat(data.ec) || 0;
                        if (data.waterLevel) sumWaterLevel += parseFloat(data.waterLevel) || 0;
                        if (data.waterTemperature) sumWaterTemp += parseFloat(data.waterTemperature) || 0;
                        if (data.nitrogen) sumNitrogen += parseFloat(data.nitrogen) || 0;
                        if (data.phosphorus) sumPhosphorus += parseFloat(data.phosphorus) || 0;
                        if (data.potassium) sumPotassium += parseFloat(data.potassium) || 0;
                    });
                    
                    console.log(`Found ${count} data points to process`);
                    
                    // Calculate averages
                    const averageData = {
                        timestamp: Math.floor((twelveHoursAgo + now) / 2), // Middle of the time period
                        period_start: twelveHoursAgo,
                        period_end: now,
                        temperature: count > 0 ? parseFloat((sumTemp / count).toFixed(2)) : null,
                        humidity: count > 0 ? parseFloat((sumHumidity / count).toFixed(2)) : null,
                        tds: count > 0 ? parseFloat((sumTds / count).toFixed(2)) : null,
                        ph: count > 0 ? parseFloat((sumPh / count).toFixed(2)) : null,
                        ec: count > 0 ? parseFloat((sumEc / count).toFixed(2)) : null,
                        waterLevel: count > 0 ? parseFloat((sumWaterLevel / count).toFixed(2)) : null,
                        waterTemperature: count > 0 ? parseFloat((sumWaterTemp / count).toFixed(2)) : null,
                        nitrogen: count > 0 ? parseFloat((sumNitrogen / count).toFixed(2)) : null,
                        phosphorus: count > 0 ? parseFloat((sumPhosphorus / count).toFixed(2)) : null,
                        potassium: count > 0 ? parseFloat((sumPotassium / count).toFixed(2)) : null,
                        data_points: count
                    };
                    
                    // Step 2: Store the average in a new node
                    const timeKey = new Date(twelveHoursAgo).toISOString().split('T')[0] + 
                                '_' + (new Date(twelveHoursAgo).getHours() < 12 ? 'AM' : 'PM');
                    
                    database.ref('aggregated_data/12h/' + timeKey).set(averageData)
                        .then(() => {
                            console.log('Successfully stored 12-hour average for ' + timeKey);
                            
                            // Step 3: Delete the processed raw data
                            const updates = {};
                            keysToDelete.forEach(key => {
                                updates['/sensor_data/' + key] = null;
                            });
                            
                            return database.ref().update(updates);
                        })
                        .then(() => {
                            console.log('Successfully deleted ' + keysToDelete.length + ' processed data points');
                            document.body.removeChild(processingNotification);
                            showNotification(`Successfully processed 12-hour average and cleaned up ${count} data points.`, 'success');
                            localStorage.setItem('lastAggregationTime', now.toString());
                        })
                        .catch(error => {
                            console.error('Error processing data:', error);
                            document.body.removeChild(processingNotification);
                            showNotification('Error processing data: ' + error.message, 'danger');
                        });
                });
        }
        
        // Function to display notification
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `alert alert-${type} alert-dismissible fade show`;
            notification.innerHTML = `
                ${type === 'success' ? '<i class="fas fa-check-circle me-2"></i>' : 
                 type === 'warning' ? '<i class="fas fa-exclamation-triangle me-2"></i>' : 
                 type === 'danger' ? '<i class="fas fa-exclamation-circle me-2"></i>' : 
                 '<i class="fas fa-info-circle me-2"></i>'}
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;
            notification.style.position = 'fixed';
            notification.style.top = '10px';
            notification.style.right = '10px';
            notification.style.zIndex = '9999';
            document.body.appendChild(notification);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 5000);
        }
        
        // Function to display aggregated data in charts
        function displayAggregatedData() {
            const database = firebase.database();
            database.ref('aggregated_data/12h').orderByChild('timestamp').limitToLast(30)
                .once('value', (snapshot) => {
                    const aggregatedData = snapshot.val();
                    if (!aggregatedData) {
                        console.log('No aggregated data available');
                        return;
                    }
                    
                    // Convert to format compatible with chart display
                    const chartData = {};
                    Object.entries(aggregatedData).forEach(([key, entry]) => {
                        chartData[key] = entry;
                    });
                    
                    // Update chart with aggregated data
                    updateChartWithData(chartData, document.getElementById('chart-parameter').value || 'temperature');
                    showNotification('Displaying aggregated historical data', 'info');
                });
        }
        
        // Function to setup automatic aggregation
        function setupAutomaticAggregation() {
            // Check if we need to run aggregation
            const lastRunTime = localStorage.getItem('lastAggregationTime');
            const now = Date.now();
            
            if (!lastRunTime || (now - parseInt(lastRunTime)) > (12 * 60 * 60 * 1000)) {
                // It's been more than 12 hours since last aggregation
                console.log('Starting automatic data aggregation...');
                process12HourAverages();
            } else {
                // Calculate time until next run
                const timeUntilNextRun = (parseInt(lastRunTime) + (12 * 60 * 60 * 1000)) - now;
                const hoursUntilNextRun = Math.round(timeUntilNextRun / (60 * 60 * 1000));
                console.log(`Next automatic aggregation in ${hoursUntilNextRun} hours`);
                
                // Show information about next scheduled run
                const nextRunTime = new Date(parseInt(lastRunTime) + (12 * 60 * 60 * 1000));
                showNotification(`Next data aggregation scheduled for ${nextRunTime.toLocaleString()}`, 'info');
            }
        }
        
        // Add data aggregation button to the control panel
        function addAggregationButton() {
            const controlPanel = document.querySelector('.card-header.bg-primary.text-white');
            if (controlPanel) {
                const aggregationButton = document.createElement('button');
                aggregationButton.className = 'btn btn-warning btn-sm float-end ms-2';
                aggregationButton.innerHTML = '<i class="fas fa-compress-alt me-1"></i> Aggregate Data';
                aggregationButton.onclick = process12HourAverages;
                controlPanel.appendChild(aggregationButton);
                
                const viewAggregatedButton = document.createElement('button');
                viewAggregatedButton.className = 'btn btn-info btn-sm float-end';
                viewAggregatedButton.innerHTML = '<i class="fas fa-chart-line me-1"></i> View Aggregated';
                viewAggregatedButton.onclick = displayAggregatedData;
                controlPanel.appendChild(viewAggregatedButton);
            }
        }
        
        // Initialize the data aggregation system when the page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Only run for admin users
            firebase.auth().onAuthStateChanged(function(user) {
                if (user) {
                    // Add the aggregation button
                    addAggregationButton();
                    
                    // Setup automatic aggregation
                    setupAutomaticAggregation();
                }
            });
        });
    </script>
</body>
</html>
